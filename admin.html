<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פאנל ניהול - תופעת טבע</title>
    <link rel="icon" href="images/logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; }
        .stat-card { transition: transform 0.15s ease; }
        .stat-card:hover { transform: translateY(-2px); }
        #table-container { overflow-x: auto; }
        table { border-collapse: collapse; min-width: 900px; }
        th { position: sticky; top: 0; z-index: 10; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #e5e7eb !important; }
        th .sort-arrow { opacity: 0.25; font-size: 0.65rem; margin-right: 2px; }
        th.sorted-asc .sort-arrow, th.sorted-desc .sort-arrow { opacity: 1; color: #16a34a; }
        tr:hover td { background-color: #f0fdf4; }
        .badge { display: inline-block; padding: 2px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .loader { border: 3px solid #d1fae5; border-top-color: #16a34a; border-radius: 50%; width: 36px; height: 36px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login page glass inputs */
        .glass-input::placeholder { color: rgba(255,255,255,.4); }
        .glass-input { caret-color: white; }

        /* Login hero background */
        #login-section {
            background: linear-gradient(150deg, #0c4a6e 0%, #0369a1 35%, #0284c7 65%, #22d3ee 100%);
        }
        #login-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: radial-gradient(rgba(255,255,255,.055) 1px, transparent 1px);
            background-size: 28px 28px;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- ─── LOGIN SECTION ─────────────────────────────────── -->
<div id="login-section" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">

    <!-- Decorative blobs -->
    <div style="position:absolute;top:-120px;right:-120px;width:520px;height:520px;border-radius:50%;background:rgba(255,255,255,.06);pointer-events:none"></div>
    <div style="position:absolute;bottom:-80px;left:-80px;width:360px;height:360px;border-radius:50%;background:rgba(255,255,255,.05);pointer-events:none"></div>
    <div style="position:absolute;top:45%;left:15%;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.04);pointer-events:none"></div>

    <div class="relative z-10 w-full max-w-sm">

        <!-- Logo + title above card -->
        <div class="text-center mb-7">
            <div class="inline-flex items-center justify-center mb-4" style="width:100px;height:100px;border-radius:50%;border:2.5px solid rgba(255,255,255,.35);padding:7px;box-shadow:0 8px 32px rgba(0,0,0,.2)">
                <div style="width:100%;height:100%;border-radius:50%;background:white;overflow:hidden;display:flex;align-items:center;justify-content:center">
                    <img src="images/logo.png" alt="תופעת טבע" style="width:72px;height:72px;object-fit:contain">
                </div>
            </div>
            <h1 class="text-3xl font-black text-white" style="text-shadow:0 2px 14px rgba(0,0,0,.25)">פאנל ניהול</h1>
            <p class="text-sm mt-1" style="color:rgba(255,255,255,.65);font-weight:500">תופעת טבע · כניסה מורשית בלבד</p>
        </div>

        <!-- Glass card -->
        <div class="rounded-3xl p-7" style="background:rgba(255,255,255,.13);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1.5px solid rgba(255,255,255,.28);box-shadow:0 24px 64px rgba(0,0,0,.22)">

            <!-- Error -->
            <div id="login-error" class="hidden mb-5 p-3.5 rounded-2xl text-sm text-center font-semibold" style="background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.35);color:#fca5a5"></div>

            <!-- Username -->
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2" style="color:rgba(255,255,255,.85)">שם משתמש</label>
                <input id="login-username" type="text" value="admin"
                    class="glass-input w-full px-4 py-3 rounded-xl text-sm font-medium outline-none transition-all"
                    style="background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.22);color:white"
                    onfocus="this.style.borderColor='rgba(255,255,255,.65)';this.style.background='rgba(255,255,255,.2)'"
                    onblur="this.style.borderColor='rgba(255,255,255,.22)';this.style.background='rgba(255,255,255,.12)'">
            </div>

            <!-- Password -->
            <div class="mb-7">
                <label class="block text-sm font-bold mb-2" style="color:rgba(255,255,255,.85)">סיסמא</label>
                <input id="login-password" type="password" placeholder="••••••••"
                    class="glass-input w-full px-4 py-3 rounded-xl text-sm font-medium outline-none transition-all"
                    style="background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.22);color:white"
                    onfocus="this.style.borderColor='rgba(255,255,255,.65)';this.style.background='rgba(255,255,255,.2)'"
                    onblur="this.style.borderColor='rgba(255,255,255,.22)';this.style.background='rgba(255,255,255,.12)'">
            </div>

            <!-- Submit -->
            <button id="login-btn"
                class="w-full font-black py-3.5 rounded-2xl text-base transition-all hover:-translate-y-0.5 hover:shadow-xl"
                style="background:rgba(255,255,255,.96);color:#0c4a6e;box-shadow:0 4px 24px rgba(0,0,0,.22)">
                כניסה למערכת
            </button>
        </div>

        <p class="text-center text-xs mt-5" style="color:rgba(255,255,255,.35)">© תופעת טבע · מערכת ניהול פנימית</p>
    </div>
</div>

<!-- ─── DASHBOARD SECTION ─────────────────────────────── -->
<div id="dashboard-section" class="hidden min-h-screen">

    <!-- Top Bar -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-screen-xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <img src="images/logo.png" alt="תופעת טבע" class="w-10 h-10 object-contain">
                <div>
                    <h1 class="font-bold text-gray-800 leading-tight">פאנל ניהול</h1>
                    <p class="text-xs text-gray-500">תופעת טבע</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="index.html" class="text-sm text-gray-500 hover:text-gray-700 hidden sm:block">→ אתר ראשי</a>
                <button id="logout-btn" class="flex items-center gap-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    יציאה
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Nav -->
    <div class="border-b border-gray-200 bg-white sticky top-[61px] z-40">
        <div class="max-w-screen-xl mx-auto px-4">
            <div class="flex gap-0">
                <button id="tab-members" onclick="switchTab('members')"
                    class="tab-btn px-6 py-3.5 text-sm font-semibold border-b-2 border-green-600 text-green-700 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    חברים
                </button>
                <button id="tab-stats" onclick="switchTab('stats')"
                    class="tab-btn px-6 py-3.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>
                    סטטיסטיקות
                </button>
                <button id="tab-analytics" onclick="switchTab('analytics')"
                    class="tab-btn px-6 py-3.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    אנליטיקה
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-screen-xl mx-auto px-4 py-6">

        <!-- ══ TAB: חברים ══ -->
        <div id="section-members">
            <!-- Stats Cards -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="stat-card bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-green-500">
                    <p class="text-3xl font-bold text-green-700" id="stat-total">-</p>
                    <p class="text-sm text-gray-500 mt-1">סה"כ נרשמו</p>
                </div>
                <div class="stat-card bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-blue-500">
                    <p class="text-3xl font-bold text-blue-700" id="stat-today">-</p>
                    <p class="text-sm text-gray-500 mt-1">הצטרפו היום</p>
                </div>
                <div class="stat-card bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-purple-500">
                    <p class="text-3xl font-bold text-purple-700" id="stat-month">-</p>
                    <p class="text-sm text-gray-500 mt-1">החודש</p>
                </div>
            </div>

            <!-- Controls: Search + Export -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
                    <div class="flex-1 relative">
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0"/></svg>
                        <input id="search-input" type="text" placeholder="חיפוש לפי שם, טלפון, עיר, ת.ז..." class="w-full pr-9 pl-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition-all">
                    </div>
                    <button id="export-btn" class="flex items-center justify-center gap-2 bg-green-700 hover:bg-green-800 text-white font-semibold px-5 py-2.5 rounded-lg transition-colors text-sm whitespace-nowrap">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        ייצוא לאקסל
                    </button>
                    <button id="refresh-btn" class="flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-4 py-2.5 rounded-lg transition-colors text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        רענן
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div id="table-loading" class="flex items-center justify-center py-16"><div class="loader"></div></div>
                <div id="table-empty" class="hidden text-center py-16 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <p class="text-lg font-medium">אין נרשמים עדיין</p>
                </div>
                <div id="table-no-results" class="hidden text-center py-16 text-gray-400">
                    <p class="text-lg font-medium">לא נמצאו תוצאות</p>
                </div>
                <div id="table-container" class="hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-200">
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50">#</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 whitespace-nowrap sortable sorted-desc" onclick="sortTable('created_at')" data-col="created_at">תאריך ושעה <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 whitespace-nowrap sortable" onclick="sortTable('name')" data-col="name">שם מלא <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 sortable" onclick="sortTable('id_number')" data-col="id_number">ת.ז. <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 sortable" onclick="sortTable('gender')" data-col="gender">מין <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 sortable" onclick="sortTable('phone')" data-col="phone">טלפון <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 sortable" onclick="sortTable('city')" data-col="city">עיר <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 sortable" onclick="sortTable('region')" data-col="region">איזור <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 whitespace-nowrap sortable" onclick="sortTable('vehicle_type')" data-col="vehicle_type">סוג רכב <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 whitespace-nowrap sortable" onclick="sortTable('vehicle_plate')" data-col="vehicle_plate">מ. רכב <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 whitespace-nowrap sortable" onclick="sortTable('birth_date')" data-col="birth_date">ת. לידה <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50 whitespace-nowrap sortable" onclick="sortTable('rescue_tools')" data-col="rescue_tools">כלי חילוץ <span class="sort-arrow">▼</span></th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-600 bg-gray-50">הערות</th>
                                <th class="px-4 py-3 bg-gray-50"></th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                    <div id="table-footer" class="px-4 py-3 border-t border-gray-200 bg-gray-50/50">
                        <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-xs">הצג</span>
                                <select id="page-size" onchange="changePageSize(this.value)" class="border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white focus:border-green-500 outline-none cursor-pointer">
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="250">250</option>
                                    <option value="500">500</option>
                                </select>
                                <span class="text-gray-500 text-xs">בעמוד</span>
                                <span class="text-gray-300 mx-1">|</span>
                                <span id="page-info" class="text-gray-500 text-xs font-medium"></span>
                            </div>
                            <div class="flex items-center gap-0.5" id="page-nav"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══ TAB: סטטיסטיקות חברים ══ -->
        <div id="section-stats" class="hidden">
            <div id="stats-loading" class="flex items-center justify-center py-16"><div class="loader"></div></div>
            <div id="stats-content" class="hidden">
                <!-- Row 1: Gender pie + Birth Year bar -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-pink-400"></span> התפלגות מין
                        </h3>
                        <div style="max-height:260px" class="flex items-center justify-center"><canvas id="chart-gender"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-indigo-400"></span> התפלגות שנת לידה
                        </h3>
                        <div style="max-height:260px"><canvas id="chart-birthyear"></canvas></div>
                    </div>
                </div>
                <!-- Row 2: Rescue tools + Vehicle type -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-amber-400"></span> כלי חילוץ שברשותי
                        </h3>
                        <div style="max-height:280px"><canvas id="chart-rescue"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-sky-400"></span> סוג רכב
                        </h3>
                        <div style="max-height:280px"><canvas id="chart-vehicle"></canvas></div>
                    </div>
                </div>
                <!-- Row 3: Region + City -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-emerald-400"></span> איזור קבוצה משפחתית
                        </h3>
                        <div style="max-height:320px"><canvas id="chart-region"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-violet-400"></span> עיר מגורים (טופ 20)
                        </h3>
                        <div style="max-height:320px"><canvas id="chart-city"></canvas></div>
                    </div>
                </div>
                <!-- Row 4: Occupation -->
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-rose-400"></span> תחום עיסוק (טופ 20)
                        </h3>
                        <div style="max-height:350px"><canvas id="chart-occupation"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══ TAB: אנליטיקה ══ -->
        <div id="section-analytics" class="hidden">

            <!-- Analytics Stats -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-white rounded-xl shadow-sm p-4 text-center border-t-4 border-sky-500">
                    <p class="text-3xl font-bold text-sky-600" id="a-today">-</p>
                    <p class="text-xs text-gray-400 mt-0.5">ביקורים</p>
                    <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-center gap-1">
                        <svg class="w-3.5 h-3.5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        <span class="text-base font-bold text-sky-700" id="a-uniq-today">-</span>
                        <span class="text-xs text-gray-400">ייחודיים</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-600 mt-1">היום</p>
                </div>
                <div class="stat-card bg-white rounded-xl shadow-sm p-4 text-center border-t-4 border-indigo-500">
                    <p class="text-3xl font-bold text-indigo-600" id="a-week">-</p>
                    <p class="text-xs text-gray-400 mt-0.5">ביקורים</p>
                    <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-center gap-1">
                        <svg class="w-3.5 h-3.5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        <span class="text-base font-bold text-indigo-700" id="a-uniq-week">-</span>
                        <span class="text-xs text-gray-400">ייחודיים</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-600 mt-1">השבוע</p>
                </div>
                <div class="stat-card bg-white rounded-xl shadow-sm p-4 text-center border-t-4 border-violet-500">
                    <p class="text-3xl font-bold text-violet-600" id="a-month">-</p>
                    <p class="text-xs text-gray-400 mt-0.5">ביקורים</p>
                    <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-center gap-1">
                        <svg class="w-3.5 h-3.5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        <span class="text-base font-bold text-violet-700" id="a-uniq-month">-</span>
                        <span class="text-xs text-gray-400">ייחודיים</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-600 mt-1">החודש</p>
                </div>
                <div class="stat-card bg-white rounded-xl shadow-sm p-4 text-center border-t-4 border-fuchsia-500">
                    <p class="text-3xl font-bold text-fuchsia-600" id="a-total">-</p>
                    <p class="text-xs text-gray-400 mt-0.5">ביקורים</p>
                    <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-center gap-1">
                        <svg class="w-3.5 h-3.5 text-fuchsia-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        <span class="text-base font-bold text-fuchsia-700" id="a-uniq-total">-</span>
                        <span class="text-xs text-gray-400">ייחודיים</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-600 mt-1">סה״כ</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <!-- Pages breakdown -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-5">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <svg class="w-4 h-4 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        ביקורים לפי עמוד
                    </h3>
                    <div id="a-pages" class="space-y-2.5"></div>
                </div>

                <!-- Device + Browser -->
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 text-sm">סוג מכשיר</h3>
                        <div id="a-devices" class="space-y-2"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-5">
                        <h3 class="font-bold text-gray-700 mb-3 text-sm">דפדפן</h3>
                        <div id="a-browsers" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Recent visits -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="font-bold text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        ביקורים אחרונים
                    </h3>
                    <button onclick="loadAnalytics()" class="text-xs text-sky-600 hover:text-sky-800 font-medium">רענן</button>
                </div>
                <div id="a-loading" class="flex items-center justify-center py-12"><div class="loader"></div></div>
                <div id="a-recent" class="hidden overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-100 text-xs text-gray-500 font-semibold uppercase tracking-wide">
                                <th class="px-4 py-3 text-right">זמן</th>
                                <th class="px-4 py-3 text-right">עמוד</th>
                                <th class="px-4 py-3 text-right">IP</th>
                                <th class="px-4 py-3 text-right">דפדפן</th>
                                <th class="px-4 py-3 text-right">מכשיר</th>
                                <th class="px-4 py-3 text-right">מקור</th>
                            </tr>
                        </thead>
                        <tbody id="a-recent-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="sticky top-0 bg-white px-6 pt-6 pb-4 border-b border-gray-100 flex items-center justify-between rounded-t-3xl">
            <div>
                <h3 class="text-xl font-black text-gray-800" id="detail-name">פרטי חבר</h3>
                <p class="text-xs text-gray-400 mt-0.5" id="detail-date"></p>
            </div>
            <button onclick="closeDetailModal()" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <!-- Body -->
        <div class="p-6 space-y-4" id="detail-body"></div>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div id="delete-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" id="delete-modal-overlay"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
        <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">מחיקת רשומה</h3>
        <p class="text-gray-600 text-sm mb-6" id="delete-modal-name">האם אתה בטוח שברצונך למחוק את הרשומה?</p>
        <div class="flex gap-3">
            <button id="delete-cancel-btn" class="flex-1 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors">ביטול</button>
            <button id="delete-confirm-btn" class="flex-1 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition-colors">מחק</button>
        </div>
    </div>
</div>

<script>
let allSubmissions = [];
let deleteTargetId = null;
let searchTimeout = null;
let currentSortCol = 'created_at';
let currentSortDir = 'desc';
let currentPage = 1;
let pageSize = 25;

// ─── Tabs ─────────────────────────────────────────────────
function switchTab(tab) {
    document.getElementById('section-members').classList.toggle('hidden', tab !== 'members');
    document.getElementById('section-stats').classList.toggle('hidden', tab !== 'stats');
    document.getElementById('section-analytics').classList.toggle('hidden', tab !== 'analytics');
    const base = 'tab-btn px-6 py-3.5 text-sm font-semibold border-b-2 transition-colors flex items-center gap-2';
    const tabStyles = { members: 'border-green-600 text-green-700', stats: 'border-purple-600 text-purple-700', analytics: 'border-sky-600 text-sky-700' };
    ['members', 'stats', 'analytics'].forEach(t => {
        document.getElementById('tab-' + t).className = t === tab
            ? `${base} ${tabStyles[t]}`
            : `${base} border-transparent text-gray-500 hover:text-gray-700`;
    });
    if (tab === 'analytics') loadAnalytics();
    if (tab === 'stats') loadMemberStats();
}

// ─── Auth ────────────────────────────────────────────────

async function checkAuth() {
    try {
        const res = await fetch('/api/admin/check');
        const data = await res.json();
        if (data.loggedIn) {
            showDashboard();
        }
    } catch (e) {
        // Stay on login
    }
}

document.getElementById('login-btn').addEventListener('click', async () => {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    const errEl = document.getElementById('login-error');
    errEl.classList.add('hidden');

    if (!username || !password) {
        errEl.textContent = 'אנא הזן שם משתמש וסיסמא';
        errEl.classList.remove('hidden');
        return;
    }

    document.getElementById('login-btn').disabled = true;
    document.getElementById('login-btn').textContent = 'מתחבר...';

    try {
        const res = await fetch('/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
            showDashboard();
        } else {
            errEl.textContent = data.message || 'שם משתמש או סיסמא שגויים';
            errEl.classList.remove('hidden');
        }
    } catch (e) {
        errEl.textContent = 'שגיאת חיבור. נסה שוב.';
        errEl.classList.remove('hidden');
    }

    document.getElementById('login-btn').disabled = false;
    document.getElementById('login-btn').textContent = 'כניסה';
});

// Allow Enter key on password field
document.getElementById('login-password').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('login-btn').click();
});

document.getElementById('logout-btn').addEventListener('click', async () => {
    await fetch('/api/admin/logout', { method: 'POST' });
    document.getElementById('dashboard-section').classList.add('hidden');
    document.getElementById('login-section').classList.remove('hidden');
    document.getElementById('login-password').value = '';
});

// ─── Dashboard ────────────────────────────────────────────

function showDashboard() {
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('dashboard-section').classList.remove('hidden');
    loadStats();
    loadSubmissions();
}

async function loadStats() {
    try {
        const res = await fetch('/api/admin/stats');
        const s = await res.json();
        document.getElementById('stat-total').textContent = s.total.toLocaleString();
        document.getElementById('stat-today').textContent = s.today.toLocaleString();
        document.getElementById('stat-month').textContent = s.thisMonth.toLocaleString();
    } catch (e) {}
}

async function loadSubmissions(query = '') {
    setTableState('loading');
    try {
        const url = query ? `/api/admin/submissions?q=${encodeURIComponent(query)}` : '/api/admin/submissions';
        const res = await fetch(url);
        allSubmissions = await res.json();
        currentPage = 1;
        renderTable(allSubmissions);
    } catch (e) {
        setTableState('empty');
    }
}

function formatDateTime(ts) {
    if (!ts) return '-';
    try {
        const d = new Date(ts);
        if (isNaN(d)) return ts.split('T')[0] || ts.split(' ')[0] || '-';
        const pad = n => String(n).padStart(2, '0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    } catch { return '-'; }
}

function sortTable(col) {
    if (currentSortCol === col) {
        currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortCol = col;
        currentSortDir = col === 'created_at' || col === 'id' ? 'desc' : 'asc';
    }
    // Update header styles
    document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        const arrow = th.querySelector('.sort-arrow');
        if (arrow) arrow.textContent = '▼';
    });
    const activeTh = document.querySelector(`th[data-col="${col}"]`);
    if (activeTh) {
        activeTh.classList.add(currentSortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
        const arrow = activeTh.querySelector('.sort-arrow');
        if (arrow) arrow.textContent = currentSortDir === 'asc' ? '▲' : '▼';
    }
    currentPage = 1;
    renderTable(allSubmissions);
}

function renderTable(rows) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';

    if (rows.length === 0) {
        const query = document.getElementById('search-input').value.trim();
        setTableState(query ? 'no-results' : 'empty');
        document.getElementById('page-info').textContent = '';
        document.getElementById('page-nav').innerHTML = '';
        return;
    }

    // Sort rows
    const sorted = [...rows].sort((a, b) => {
        let valA, valB;
        if (currentSortCol === 'name') {
            valA = ((a.first_name || '') + ' ' + (a.last_name || '')).trim().toLowerCase();
            valB = ((b.first_name || '') + ' ' + (b.last_name || '')).trim().toLowerCase();
        } else if (currentSortCol === 'created_at') {
            valA = new Date(a.created_at || 0).getTime();
            valB = new Date(b.created_at || 0).getTime();
        } else if (currentSortCol === 'id') {
            valA = a.id || 0;
            valB = b.id || 0;
        } else {
            valA = (a[currentSortCol] || '').toString().toLowerCase();
            valB = (b[currentSortCol] || '').toString().toLowerCase();
        }
        let cmp = 0;
        if (typeof valA === 'number' && typeof valB === 'number') {
            cmp = valA - valB;
        } else {
            cmp = String(valA).localeCompare(String(valB), 'he');
        }
        return currentSortDir === 'asc' ? cmp : -cmp;
    });

    // Pagination
    const totalRows = sorted.length;
    const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = Math.min(startIdx + pageSize, totalRows);
    const pageRows = sorted.slice(startIdx, endIdx);

    setTableState('data');
    pageRows.forEach((r, i) => {
        const rowNum = startIdx + i + 1;
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-100 cursor-pointer';
        tr.title = 'לחץ לפרטים מלאים';
        tr.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            openDetailModal(r);
        });
        const dateStr = formatDateTime(r.created_at);
        const genderBadge = r.gender === 'זכר'
            ? '<span class="badge bg-blue-100 text-blue-700">זכר</span>'
            : r.gender === 'נקבה'
            ? '<span class="badge bg-pink-100 text-pink-700">נקבה</span>'
            : `<span class="badge bg-gray-100 text-gray-600">${r.gender || '-'}</span>`;
        const safeName = (r.first_name + ' ' + r.last_name).replace(/'/g, "\\'").replace(/"/g, '&quot;');

        tr.innerHTML = `
            <td class="px-4 py-3 text-gray-400 text-xs font-mono">${rowNum}</td>
            <td class="px-4 py-3 text-gray-600 whitespace-nowrap text-xs">${dateStr}</td>
            <td class="px-4 py-3 font-semibold text-gray-800 whitespace-nowrap">${r.first_name || ''} ${r.last_name || ''}</td>
            <td class="px-4 py-3 text-gray-600 font-mono text-xs">${r.id_number || '-'}</td>
            <td class="px-4 py-3">${genderBadge}</td>
            <td class="px-4 py-3 text-gray-700 whitespace-nowrap font-mono text-xs">${r.phone || '-'}</td>
            <td class="px-4 py-3 text-gray-600 whitespace-nowrap">${r.city || '-'}</td>
            <td class="px-4 py-3 text-gray-600 whitespace-nowrap">${r.region || '-'}</td>
            <td class="px-4 py-3 text-gray-600 whitespace-nowrap text-xs">${r.vehicle_type || '-'}</td>
            <td class="px-4 py-3 text-gray-600 font-mono text-xs">${r.vehicle_plate || '-'}</td>
            <td class="px-4 py-3 text-gray-600 whitespace-nowrap text-xs">${r.birth_date || '-'}</td>
            <td class="px-4 py-3 text-gray-600 text-xs max-w-[140px] truncate" title="${(r.rescue_tools || '').replace(/"/g, '&quot;')}">${r.rescue_tools || '-'}</td>
            <td class="px-4 py-3 text-gray-500 text-xs max-w-[120px] truncate" title="${(r.notes || '').replace(/"/g, '&quot;')}">${r.notes || '-'}</td>
            <td class="px-4 py-3">
                <button onclick="openDeleteModal(${r.id}, '${safeName}')"
                    class="text-red-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-lg transition-colors" title="מחק">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Update pagination
    document.getElementById('page-info').textContent = `מציג ${(startIdx + 1).toLocaleString()}-${endIdx.toLocaleString()} מתוך ${totalRows.toLocaleString()}`;
    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const nav = document.getElementById('page-nav');
    if (totalPages <= 1) { nav.innerHTML = ''; return; }
    const btnClass = 'px-2.5 py-1 rounded-lg text-xs font-medium transition-colors';
    const mkBtn = (label, page, active, disabled) => {
        if (disabled) return `<button class="${btnClass} text-gray-300 cursor-default" disabled>${label}</button>`;
        if (active) return `<button class="${btnClass} bg-green-600 text-white shadow-sm">${label}</button>`;
        return `<button onclick="changePage(${page})" class="${btnClass} hover:bg-gray-100 text-gray-600">${label}</button>`;
    };
    let html = mkBtn('«', 1, false, currentPage === 1);
    html += mkBtn('‹', currentPage - 1, false, currentPage === 1);
    let startP = Math.max(1, currentPage - 2);
    let endP = Math.min(totalPages, currentPage + 2);
    if (endP - startP < 4) {
        if (startP === 1) endP = Math.min(totalPages, 5);
        else startP = Math.max(1, totalPages - 4);
    }
    if (startP > 1) { html += mkBtn('1', 1, false, false); if (startP > 2) html += '<span class="px-1 text-gray-300 text-xs">…</span>'; }
    for (let p = startP; p <= endP; p++) html += mkBtn(p, p, p === currentPage, false);
    if (endP < totalPages) { if (endP < totalPages - 1) html += '<span class="px-1 text-gray-300 text-xs">…</span>'; html += mkBtn(totalPages, totalPages, false, false); }
    html += mkBtn('›', currentPage + 1, false, currentPage === totalPages);
    html += mkBtn('»', totalPages, false, currentPage === totalPages);
    nav.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    renderTable(allSubmissions);
    document.getElementById('table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function changePageSize(size) {
    pageSize = parseInt(size);
    currentPage = 1;
    renderTable(allSubmissions);
}

function setTableState(state) {
    document.getElementById('table-loading').classList.toggle('hidden', state !== 'loading');
    document.getElementById('table-empty').classList.toggle('hidden', state !== 'empty');
    document.getElementById('table-no-results').classList.toggle('hidden', state !== 'no-results');
    document.getElementById('table-container').classList.toggle('hidden', state !== 'data');
}

// ─── Search ───────────────────────────────────────────────

document.getElementById('search-input').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadSubmissions(e.target.value.trim()), 350);
});

// ─── Export ───────────────────────────────────────────────

document.getElementById('export-btn').addEventListener('click', () => {
    window.open('/api/admin/export', '_blank');
});

// ─── Refresh ─────────────────────────────────────────────

document.getElementById('refresh-btn').addEventListener('click', () => {
    const q = document.getElementById('search-input').value.trim();
    loadStats();
    loadSubmissions(q);
});

// ─── Delete Modal ─────────────────────────────────────────

function openDeleteModal(id, name) {
    deleteTargetId = id;
    document.getElementById('delete-modal-name').textContent = `מחיקת הרשומה של ${name}. פעולה זו אינה הפיכה.`;
    document.getElementById('delete-modal').classList.remove('hidden');
}

document.getElementById('delete-cancel-btn').addEventListener('click', closeDeleteModal);
document.getElementById('delete-modal-overlay').addEventListener('click', (e) => {
    // Modal doesn't close on overlay click (per policy)
});

function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    deleteTargetId = null;
}

document.getElementById('delete-confirm-btn').addEventListener('click', async () => {
    if (!deleteTargetId) return;
    const btn = document.getElementById('delete-confirm-btn');
    btn.disabled = true;
    btn.textContent = 'מוחק...';

    try {
        await fetch(`/api/admin/submissions/${deleteTargetId}`, { method: 'DELETE' });
        closeDeleteModal();
        loadStats();
        const q = document.getElementById('search-input').value.trim();
        loadSubmissions(q);
    } catch (e) {
        btn.textContent = 'שגיאה - נסה שוב';
    }

    btn.disabled = false;
    btn.textContent = 'מחק';
});

// ─── Analytics ────────────────────────────────────────────
async function loadAnalytics() {
    document.getElementById('a-loading').classList.remove('hidden');
    document.getElementById('a-recent').classList.add('hidden');
    try {
        const res = await fetch('/api/admin/analytics');
        const data = await res.json();

        // Stats — visits
        document.getElementById('a-today').textContent = data.stats.today.toLocaleString();
        document.getElementById('a-week').textContent = data.stats.week.toLocaleString();
        document.getElementById('a-month').textContent = data.stats.month.toLocaleString();
        document.getElementById('a-total').textContent = data.stats.total.toLocaleString();
        // Unique visitors
        document.getElementById('a-uniq-today').textContent = (data.stats.uniqueToday || 0).toLocaleString();
        document.getElementById('a-uniq-week').textContent = (data.stats.uniqueWeek || 0).toLocaleString();
        document.getElementById('a-uniq-month').textContent = (data.stats.uniqueMonth || 0).toLocaleString();
        document.getElementById('a-uniq-total').textContent = (data.stats.uniqueTotal || 0).toLocaleString();

        // Pages
        const maxVisits = data.pages[0]?.visits || 1;
        document.getElementById('a-pages').innerHTML = data.pages.slice(0, 12).map(p => {
            const pct = Math.round((p.visits / maxVisits) * 100);
            const label = p.page.replace('.html', '') || 'index';
            return `<div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="font-medium text-gray-700">/${label}</span>
                    <span class="text-gray-400">${p.visits} ביקורים · היום: ${p.today}</span>
                </div>
                <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-l from-sky-400 to-sky-600 rounded-full transition-all" style="width:${pct}%"></div>
                </div>
            </div>`;
        }).join('');

        // Devices
        const totalDev = Object.values(data.devices).reduce((a,b)=>a+b,0) || 1;
        document.getElementById('a-devices').innerHTML = Object.entries(data.devices)
            .sort((a,b) => b[1]-a[1])
            .map(([name, count]) => `
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-base">${name === 'נייד' ? '📱' : name === 'טאבלט' ? '📋' : '🖥️'}</span>
                    <span class="flex-1 text-gray-600">${name}</span>
                    <span class="font-bold text-gray-800">${count}</span>
                    <span class="text-xs text-gray-400">${Math.round(count/totalDev*100)}%</span>
                </div>`).join('');

        // Browsers
        const totalBr = Object.values(data.browsers).reduce((a,b)=>a+b,0) || 1;
        const brColors = { Chrome:'bg-yellow-400', Firefox:'bg-orange-400', Safari:'bg-blue-400', Edge:'bg-teal-400', אחר:'bg-gray-400' };
        document.getElementById('a-browsers').innerHTML = Object.entries(data.browsers)
            .sort((a,b) => b[1]-a[1])
            .map(([name, count]) => `
                <div class="flex items-center gap-2 text-sm">
                    <div class="w-2.5 h-2.5 rounded-full flex-shrink-0 ${brColors[name] || 'bg-gray-400'}"></div>
                    <span class="flex-1 text-gray-600">${name}</span>
                    <span class="font-bold text-gray-800">${count}</span>
                    <span class="text-xs text-gray-400">${Math.round(count/totalBr*100)}%</span>
                </div>`).join('');

        // Recent visits
        const tbody = document.getElementById('a-recent-body');
        tbody.innerHTML = data.recent.map(v => {
            const dt = v.timestamp ? new Date(v.timestamp).toLocaleString('he-IL', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }) : '';
            const ref = v.referrer ? (v.referrer.length > 30 ? v.referrer.slice(0,30)+'…' : v.referrer) : '—';
            return `<tr class="border-b border-gray-50 hover:bg-gray-50 text-xs">
                <td class="px-4 py-2.5 text-gray-500 whitespace-nowrap">${dt}</td>
                <td class="px-4 py-2.5 font-medium text-gray-700">/${(v.page||'').replace('.html','')}</td>
                <td class="px-4 py-2.5 text-gray-500 font-mono">${v.ip || '—'}</td>
                <td class="px-4 py-2.5 text-gray-500">${v.browser || '—'}</td>
                <td class="px-4 py-2.5 text-gray-500">${v.device || '—'}</td>
                <td class="px-4 py-2.5 text-gray-400 max-w-[120px] truncate" title="${v.referrer || ''}">${ref}</td>
            </tr>`;
        }).join('');

        document.getElementById('a-loading').classList.add('hidden');
        document.getElementById('a-recent').classList.remove('hidden');
    } catch (e) {
        document.getElementById('a-loading').innerHTML = '<p class="text-gray-400 text-sm">שגיאה בטעינת נתונים</p>';
    }
}

// ─── Member Stats Charts ──────────────────────────────────
let chartsLoaded = false;
const chartInstances = {};

async function loadMemberStats() {
    if (chartsLoaded) return;
    document.getElementById('stats-loading').classList.remove('hidden');
    document.getElementById('stats-content').classList.add('hidden');
    try {
        const res = await fetch('/api/admin/member-stats');
        const data = await res.json();

        const colors = {
            bg: ['rgba(34,197,94,0.7)','rgba(59,130,246,0.7)','rgba(168,85,247,0.7)','rgba(249,115,22,0.7)','rgba(236,72,153,0.7)','rgba(20,184,166,0.7)','rgba(245,158,11,0.7)','rgba(99,102,241,0.7)','rgba(239,68,68,0.7)','rgba(107,114,128,0.7)'],
            border: ['rgb(34,197,94)','rgb(59,130,246)','rgb(168,85,247)','rgb(249,115,22)','rgb(236,72,153)','rgb(20,184,166)','rgb(245,158,11)','rgb(99,102,241)','rgb(239,68,68)','rgb(107,114,128)']
        };
        const defaults = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

        // Gender - Doughnut
        const gLabels = Object.keys(data.gender);
        const gValues = Object.values(data.gender);
        chartInstances.gender = new Chart(document.getElementById('chart-gender'), {
            type: 'doughnut',
            data: { labels: gLabels, datasets: [{ data: gValues, backgroundColor: ['rgba(59,130,246,0.7)','rgba(236,72,153,0.7)','rgba(168,85,247,0.7)','rgba(107,114,128,0.7)'], borderWidth: 2, borderColor: '#fff' }] },
            options: { ...defaults, plugins: { legend: { display: true, position: 'bottom', rtl: true, labels: { font: { family: 'Heebo', size: 12 }, padding: 12 } } }, cutout: '55%' }
        });

        // Birth Year - Bar (sorted by year)
        const byEntries = Object.entries(data.birth_year).sort((a,b) => a[0] - b[0]);
        chartInstances.birthyear = new Chart(document.getElementById('chart-birthyear'), {
            type: 'bar',
            data: { labels: byEntries.map(e=>e[0]), datasets: [{ data: byEntries.map(e=>e[1]), backgroundColor: 'rgba(99,102,241,0.6)', borderColor: 'rgb(99,102,241)', borderWidth: 1, borderRadius: 3 }] },
            options: { ...defaults, scales: { y: { beginAtZero: true, ticks: { font: { family: 'Heebo' } } }, x: { ticks: { font: { family: 'Heebo', size: 10 }, maxRotation: 45 } } } }
        });

        // Rescue Tools - Horizontal bar
        const rtEntries = Object.entries(data.rescue_tools).sort((a,b) => b[1]-a[1]);
        chartInstances.rescue = new Chart(document.getElementById('chart-rescue'), {
            type: 'bar',
            data: { labels: rtEntries.map(e=>e[0]), datasets: [{ data: rtEntries.map(e=>e[1]), backgroundColor: 'rgba(245,158,11,0.6)', borderColor: 'rgb(245,158,11)', borderWidth: 1, borderRadius: 3 }] },
            options: { ...defaults, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { family: 'Heebo' } } }, y: { ticks: { font: { family: 'Heebo', size: 11 } } } } }
        });

        // Vehicle - Horizontal bar (top 15)
        const vEntries = Object.entries(data.vehicle_type).sort((a,b) => b[1]-a[1]).slice(0, 15);
        chartInstances.vehicle = new Chart(document.getElementById('chart-vehicle'), {
            type: 'bar',
            data: { labels: vEntries.map(e=>e[0]), datasets: [{ data: vEntries.map(e=>e[1]), backgroundColor: 'rgba(14,165,233,0.6)', borderColor: 'rgb(14,165,233)', borderWidth: 1, borderRadius: 3 }] },
            options: { ...defaults, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { family: 'Heebo' } } }, y: { ticks: { font: { family: 'Heebo', size: 11 } } } } }
        });

        // Region - Horizontal bar
        const regEntries = Object.entries(data.region).sort((a,b) => b[1]-a[1]);
        chartInstances.region = new Chart(document.getElementById('chart-region'), {
            type: 'bar',
            data: { labels: regEntries.map(e=>e[0]), datasets: [{ data: regEntries.map(e=>e[1]), backgroundColor: 'rgba(16,185,129,0.6)', borderColor: 'rgb(16,185,129)', borderWidth: 1, borderRadius: 3 }] },
            options: { ...defaults, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { family: 'Heebo' } } }, y: { ticks: { font: { family: 'Heebo', size: 11 } } } } }
        });

        // City - Horizontal bar (top 20)
        const cityEntries = Object.entries(data.city).sort((a,b) => b[1]-a[1]).slice(0, 20);
        chartInstances.city = new Chart(document.getElementById('chart-city'), {
            type: 'bar',
            data: { labels: cityEntries.map(e=>e[0]), datasets: [{ data: cityEntries.map(e=>e[1]), backgroundColor: 'rgba(139,92,246,0.6)', borderColor: 'rgb(139,92,246)', borderWidth: 1, borderRadius: 3 }] },
            options: { ...defaults, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { family: 'Heebo' } } }, y: { ticks: { font: { family: 'Heebo', size: 11 } } } } }
        });

        // Occupation - Horizontal bar (top 20)
        const occEntries = Object.entries(data.occupation).sort((a,b) => b[1]-a[1]).slice(0, 20);
        chartInstances.occupation = new Chart(document.getElementById('chart-occupation'), {
            type: 'bar',
            data: { labels: occEntries.map(e=>e[0]), datasets: [{ data: occEntries.map(e=>e[1]), backgroundColor: 'rgba(244,63,94,0.6)', borderColor: 'rgb(244,63,94)', borderWidth: 1, borderRadius: 3 }] },
            options: { ...defaults, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { family: 'Heebo' } } }, y: { ticks: { font: { family: 'Heebo', size: 11 } } } } }
        });

        chartsLoaded = true;
        document.getElementById('stats-loading').classList.add('hidden');
        document.getElementById('stats-content').classList.remove('hidden');
    } catch (e) {
        document.getElementById('stats-loading').innerHTML = '<p class="text-gray-400 text-sm">שגיאה בטעינת נתונים</p>';
    }
}

// ─── Detail Modal ──────────────────────────────────────────
function openDetailModal(r) {
    const dateStr = r.created_at ? new Date(r.created_at).toLocaleString('he-IL') : '';
    document.getElementById('detail-name').textContent = `${r.first_name || ''} ${r.last_name || ''}`.trim();
    document.getElementById('detail-date').textContent = `הצטרף/ה: ${dateStr} · מזהה: #${r.id}`;

    const field = (label, value, icon='') => value
        ? `<div class="flex gap-3 items-start">
               <span class="text-lg flex-shrink-0 mt-0.5">${icon}</span>
               <div>
                   <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">${label}</p>
                   <p class="text-sm font-medium text-gray-800 mt-0.5">${value}</p>
               </div>
           </div>`
        : '';

    const genderIcon = r.gender === 'זכר' ? '👨' : r.gender === 'נקבה' ? '👩' : '🧑';
    const tools = r.rescue_tools || '—';
    const termsIcon = r.terms_agreed ? '✅' : '❌';

    document.getElementById('detail-body').innerHTML = `
        <div class="grid grid-cols-2 gap-3">
            ${field('שם פרטי', r.first_name, '👤')}
            ${field('שם משפחה', r.last_name, '👤')}
            ${field('תעודת זהות', r.id_number, '🪪')}
            ${field('מין', r.gender, genderIcon)}
            ${field('טלפון', r.phone ? `<a href="tel:${r.phone}" class="text-sky-600 underline">${r.phone}</a>` : '', '📞')}
            ${field('תאריך לידה', r.birth_date, '🎂')}
        </div>
        <hr class="border-gray-100">
        <div class="grid grid-cols-2 gap-3">
            ${field('עיר מגורים', r.city, '🏘️')}
            ${field('איזור קבוצה', r.region, '📍')}
        </div>
        <hr class="border-gray-100">
        <div class="grid grid-cols-2 gap-3">
            ${field('סוג רכב', r.vehicle_type, '🚙')}
            ${field('מספר רכב', r.vehicle_plate, '🔢')}
        </div>
        ${r.occupation ? `<hr class="border-gray-100">${field('תחום עיסוק', r.occupation, '💼')}` : ''}
        ${tools !== '—' ? `<hr class="border-gray-100"><div>${field('כלי חילוץ ברשותו', tools, '🔧')}</div>` : ''}
        ${r.notes ? `<hr class="border-gray-100"><div class="flex gap-3 items-start"><span class="text-lg">📝</span><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">הערות</p><p class="text-sm text-gray-700 leading-relaxed bg-gray-50 rounded-xl p-3">${r.notes}</p></div></div>` : ''}
        <hr class="border-gray-100">
        ${field('אישור תקנון', r.terms_agreed ? 'אישר/ה' : 'לא אישר/ה', termsIcon)}
        <div class="pt-2 flex gap-2">
            <button onclick="closeDetailModal();openDeleteModal(${r.id},'${(r.first_name+' '+r.last_name).replace(/'/g,"\\'")}')"
                class="flex items-center gap-1.5 text-sm text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors font-medium">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                מחק רשומה
            </button>
        </div>`;

    document.getElementById('detail-modal').classList.remove('hidden');
}

function closeDetailModal() {
    document.getElementById('detail-modal').classList.add('hidden');
}

// ─── Init ─────────────────────────────────────────────────
checkAuth();
</script>
</body>
</html>
